<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GraphiQL - GraphQL IDE</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .graphiql-container {
      height: 100vh;
    }
    .header {
      background: linear-gradient(135deg, #e91e63 0%, #9c27b0 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }
    .header h1 {
      margin: 0;
      font-size: 2rem;
    }
    .header p {
      margin: 10px 0 0 0;
      opacity: 0.9;
    }
    .loading {
      text-align: center;
      padding: 50px;
      font-size: 18px;
      color: #666;
    }
    .fallback {
      text-align: center;
      padding: 50px;
      background: #f8f9fa;
      border-radius: 10px;
      margin: 20px;
    }
    .fallback a {
      color: #e91e63;
      text-decoration: none;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ”® GraphiQL</h1>
    <p>GraphQL æŸ¥è¯¢å’Œæµ‹è¯•å·¥å…·</p>
  </div>
  
  <div id="graphiql" class="graphiql-container">
    <div class="loading">æ­£åœ¨åŠ è½½ GraphiQL...</div>
  </div>

  <!-- ä½¿ç”¨æ›´ç¨³å®šçš„ CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/graphiql@2.4.7/graphiql.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/graphiql@2.4.7/graphiql.css" />

  <script>
    // ç­‰å¾…æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆ
    window.addEventListener('load', function() {
      try {
        // æ£€æŸ¥ GraphiQL æ˜¯å¦å¯ç”¨
        if (typeof GraphiQL === 'undefined') {
          showFallback('GraphiQL åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
          return;
        }

        // åˆ›å»ºå®Œå…¨è‡ªå®šä¹‰çš„ fetcher
        const fetcher = GraphiQL.createFetcher({
          url: '/graphql',
          // å®Œå…¨è‡ªå®šä¹‰çš„è¯·æ±‚å¤„ç†
          fetch: async (url, options) => {
            console.log('GraphiQL fetcher called with:', { url, options });
            
            // ç¡®ä¿è¯·æ±‚å¤´æ­£ç¡®
            const headers = {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
            };

            // å¤„ç†è¯·æ±‚ä½“
            let body = null;
            if (options.body) {
              try {
                const parsedBody = JSON.parse(options.body);
                console.log('Parsed request body:', parsedBody);
                
                // é‡æ–°æ„å»ºè¯·æ±‚ä½“ï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®
                body = JSON.stringify({
                  query: parsedBody.query || '',
                  variables: parsedBody.variables || {},
                  operationName: parsedBody.operationName || null
                });
                
                console.log('Reconstructed request body:', body);
              } catch (e) {
                console.error('Error parsing request body:', e);
                body = options.body;
              }
            }

            // åˆ›å»ºæ–°çš„è¯·æ±‚é€‰é¡¹
            const fetchOptions = {
              method: 'POST',
              headers: headers,
              body: body
            };

            console.log('Final fetch options:', fetchOptions);

            // å‘é€è¯·æ±‚
            const response = await fetch(url, fetchOptions);
            console.log('Response status:', response.status);
            
            // æ£€æŸ¥å“åº”
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            return response;
          }
        });

        // æ¸²æŸ“ GraphiQL
        const root = ReactDOM.createRoot(document.getElementById('graphiql'));
        root.render(React.createElement(GraphiQL, {
          fetcher: fetcher,
          defaultQuery: `# æ¬¢è¿ä½¿ç”¨ GraphiQL!
# è¿™æ˜¯ä¸€ä¸ª GraphQL æŸ¥è¯¢ç¤ºä¾‹

query {
  blogs {
    id
    title
    author
  }
  products {
    id
    title
    price
  }
}`,
          defaultVariables: `{
  "example": "å˜é‡ç¤ºä¾‹"
}`,
          defaultHeaders: `{
  "Content-Type": "application/json"
}`,
          // æ·»åŠ æ›´å¤šé…ç½®é€‰é¡¹
          showQueryTitle: true,
          showQueryFacts: true,
          showQueryPlan: false,
          showQuerySearch: true,
          showQueryToolbar: true,
          showQuerySettings: true,
          showQueryHistory: true,
          showQueryDocumentation: true,
          showQueryExplorer: true,
          showQuerySchema: true,
          showQueryVariables: true,
          showQueryHeaders: true,
          showQueryResults: true,
          showQueryError: true,
          showQueryLoading: true,
          showQuerySuccess: true,
        }));

        console.log('GraphiQL åˆå§‹åŒ–æˆåŠŸ');

      } catch (error) {
        console.error('GraphiQL åˆå§‹åŒ–å¤±è´¥:', error);
        showFallback(`GraphiQL åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
      }
    });

    function showFallback(message) {
      document.getElementById('graphiql').innerHTML = `
        <div class="fallback">
          <h3>âŒ ${message}</h3>
          <p>å»ºè®®ä½¿ç”¨æˆ‘ä»¬çš„ç®€å•æµ‹è¯•å·¥å…·ï¼Œå®ƒæ›´ç¨³å®šä¸”åŠŸèƒ½å®Œæ•´</p>
          <p><a href="/graphql-test">ğŸš€ æ‰“å¼€ç®€å•æµ‹è¯•å·¥å…·</a></p>
          <button onclick="location.reload()" style="padding: 10px 20px; background: #e91e63; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px;">
            åˆ·æ–°é¡µé¢é‡è¯•
          </button>
        </div>
      `;
    }

    // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
    window.addEventListener('error', function(e) {
      console.error('Global error:', e.error);
      if (e.error && e.error.message && e.error.message.includes('GraphiQL')) {
        showFallback('GraphiQL è¿è¡Œæ—¶é”™è¯¯ï¼Œè¯·ä½¿ç”¨ç®€å•æµ‹è¯•å·¥å…·');
      }
    });
  </script>
</body>
</html>
